#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Ù…Ù„Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙˆØ§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨ÙˆØª
"""

import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.constants import ParseMode

from database import Database
from config import ADMIN_ID

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
db = Database()

async def is_admin(user_id):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹"""
    return str(user_id) == ADMIN_ID or db.is_admin(str(user_id))

async def admin_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ù…Ø± /admin Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†"""
    user_id = str(update.effective_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        await update.message.reply_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.")
        return
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„
    keyboard = [
        [InlineKeyboardButton("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ğŸ‘¥", callback_data="admin_manage_admins")],
        [InlineKeyboardButton("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ğŸ‘¤", callback_data="admin_manage_users")],
        [InlineKeyboardButton("Ø¥Ø¯Ø§Ø±Ø© Ù…ÙØ§ØªÙŠØ­ API ğŸ”‘", callback_data="admin_manage_api_keys")],
        [InlineKeyboardButton("Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª ğŸ“Š", callback_data="admin_stats")],
        [InlineKeyboardButton("Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ ğŸ“£", callback_data="admin_broadcast")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡:",
        reply_markup=reply_markup
    )

async def admin_manage_admins_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(query.from_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        await query.edit_message_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.")
        return
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
    admins = db.get_all_admins()
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù†Øµ Ø¨Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
    admin_list_text = "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†:\n\n"
    for admin_id in admins:
        admin_list_text += f"â€¢ {admin_id}\n"
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
    keyboard = [
        [InlineKeyboardButton("Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„ â•", callback_data="admin_add_admin")],
        [InlineKeyboardButton("Ø¥Ø²Ø§Ù„Ø© Ù…Ø³Ø¤ÙˆÙ„ â–", callback_data="admin_remove_admin")],
        [InlineKeyboardButton("Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ğŸ”™", callback_data="admin_back")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(admin_list_text, reply_markup=reply_markup)

async def admin_add_admin_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„ Ø¬Ø¯ÙŠØ¯"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(query.from_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        await query.edit_message_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.")
        return
    
    # Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    context.user_data['admin_action'] = 'add_admin'
    
    await query.edit_message_text(
        "ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡ ÙƒÙ…Ø³Ø¤ÙˆÙ„.\n"
        "ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø© (Ù…Ø«Ù„ 123456789).",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø¥Ù„ØºØ§Ø¡ âŒ", callback_data="admin_cancel")]])
    )

async def admin_remove_admin_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø²Ø§Ù„Ø© Ù…Ø³Ø¤ÙˆÙ„"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(query.from_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        await query.edit_message_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.")
        return
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
    admins = db.get_all_admins()
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
    keyboard = []
    for admin_id in admins:
        # Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        if admin_id != ADMIN_ID:
            keyboard.append([InlineKeyboardButton(f"Ø¥Ø²Ø§Ù„Ø© {admin_id}", callback_data=f"admin_remove_{admin_id}")])
    
    keyboard.append([InlineKeyboardButton("Ø§Ù„Ø¹ÙˆØ¯Ø© ğŸ”™", callback_data="admin_manage_admins")])
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„ØªÙ‡:", reply_markup=reply_markup)

async def admin_process_remove_admin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø²Ø§Ù„Ø© Ù…Ø³Ø¤ÙˆÙ„ Ù…Ø­Ø¯Ø¯"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(query.from_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        await query.edit_message_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.")
        return
    
    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø²Ø§Ù„ØªÙ‡
    admin_to_remove = query.data.split('_')[-1]
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„ÙŠØ³ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    if admin_to_remove == ADMIN_ID:
        await query.edit_message_text("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.")
        return
    
    # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    db.remove_admin(admin_to_remove)
    logger.info(f"ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ {admin_to_remove} Ø¨ÙˆØ§Ø³Ø·Ø© {user_id}")
    
    await query.edit_message_text(
        f"ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ {admin_to_remove} Ø¨Ù†Ø¬Ø§Ø­.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø§Ù„Ø¹ÙˆØ¯Ø© ğŸ”™", callback_data="admin_manage_admins")]])
    )

async def admin_process_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„"""
    user_id = str(update.effective_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        return
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ
    if 'admin_action' in context.user_data:
        action = context.user_data['admin_action']
        
        if action == 'add_admin':
            # Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„ Ø¬Ø¯ÙŠØ¯
            new_admin_id = update.message.text.strip()
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¹Ø±Ù
            if not new_admin_id.isdigit():
                await update.message.reply_text(
                    "Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø±Ù Ø±Ù‚Ù…ÙŠ ØµØ­ÙŠØ­.",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø¥Ù„ØºØ§Ø¡ âŒ", callback_data="admin_cancel")]])
                )
                return
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
            if db.is_admin(new_admin_id):
                await update.message.reply_text(
                    "Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„.",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø§Ù„Ø¹ÙˆØ¯Ø© ğŸ”™", callback_data="admin_manage_admins")]])
                )
                return
            
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            db.add_admin(new_admin_id, user_id)
            logger.info(f"ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„ Ø¬Ø¯ÙŠØ¯ {new_admin_id} Ø¨ÙˆØ§Ø³Ø·Ø© {user_id}")
            
            # Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
            del context.user_data['admin_action']
            
            await update.message.reply_text(
                f"ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ {new_admin_id} Ø¨Ù†Ø¬Ø§Ø­.",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø§Ù„Ø¹ÙˆØ¯Ø© ğŸ”™", callback_data="admin_manage_admins")]])
            )
        
        elif action == 'broadcast':
            # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
            broadcast_message = update.message.text
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            users = db.get_all_users()
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
            success_count = 0
            fail_count = 0
            
            await update.message.reply_text(f"Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ {len(users)} Ù…Ø³ØªØ®Ø¯Ù…...")
            
            for user_id in users:
                try:
                    await context.bot.send_message(chat_id=user_id, text=broadcast_message)
                    success_count += 1
                except Exception as e:
                    logger.error(f"ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: {e}")
                    fail_count += 1
            
            # Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
            del context.user_data['admin_action']
            
            await update.message.reply_text(
                f"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ {success_count} Ù…Ø³ØªØ®Ø¯Ù….\n"
                f"ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ {fail_count} Ù…Ø³ØªØ®Ø¯Ù….",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø§Ù„Ø¹ÙˆØ¯Ø© ğŸ”™", callback_data="admin_back")]])
            )

async def admin_broadcast_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(query.from_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        await query.edit_message_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.")
        return
    
    # Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    context.user_data['admin_action'] = 'broadcast'
    
    await query.edit_message_text(
        "ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø¥Ù„ØºØ§Ø¡ âŒ", callback_data="admin_cancel")]])
    )

async def admin_stats_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(query.from_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        await query.edit_message_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.")
        return
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    stats = db.get_user_stats()
    
    stats_text = f"""ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª:

ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {stats['total_users']}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† (24 Ø³Ø§Ø¹Ø©): {stats['active_users']}
ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚: {stats['total_spent']} â­
ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­: {stats['total_balance']} â­
"""
    
    await query.edit_message_text(
        stats_text,
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø§Ù„Ø¹ÙˆØ¯Ø© ğŸ”™", callback_data="admin_back")]])
    )

async def admin_manage_users_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(query.from_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        await query.edit_message_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.")
        return
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    keyboard = [
        [InlineKeyboardButton("Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… ğŸ”", callback_data="admin_search_user")],
        [InlineKeyboardButton("ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ù…Ø­ÙØ¸Ø© ğŸ’°", callback_data="admin_edit_wallet")],
        [InlineKeyboardButton("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… ğŸŒŸ", callback_data="admin_edit_subscription")],
        [InlineKeyboardButton("Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ğŸ”™", callback_data="admin_back")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text("Ø§Ø®ØªØ± Ø¥Ø¬Ø±Ø§Ø¡ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", reply_markup=reply_markup)

async def admin_search_user_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(query.from_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        await query.edit_message_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.")
        return
    
    # Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    context.user_data['admin_action'] = 'search_user'
    
    await query.edit_message_text(
        "ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø¥Ù„ØºØ§Ø¡ âŒ", callback_data="admin_cancel")]])
    )

async def admin_edit_wallet_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ù…Ø­ÙØ¸Ø© Ù…Ø³ØªØ®Ø¯Ù…"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(query.from_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        await query.edit_message_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.")
        return
    
    # Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    context.user_data['admin_action'] = 'edit_wallet_user_id'
    
    await query.edit_message_text(
        "ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ù…Ø­ÙØ¸ØªÙ‡.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø¥Ù„ØºØ§Ø¡ âŒ", callback_data="admin_cancel")]])
    )

async def admin_edit_subscription_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù…"""
    query = update.callback_query
    await query.answer()
    
    user_id = str(query.from_user.id)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if not await is_admin(user_id):
        await query.edit_message_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.")
        return
    
    # Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    context.user_data['admin_action'] = 'edit_subscription_user_id'
    
    await query.edit_message_text(
        "ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙ‡.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø¥Ù„ØºØ§Ø¡ âŒ", callback_data="admin_cancel")]])
    )

async def admin_cancel_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ"""
    query = update.callback_query
    await query.answer()
    
    # Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
    if 'admin_action' in context.user_data:
        del context.user_data['admin_action']
    
    await query.edit_message_text(
        "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("Ø§Ù„Ø¹ÙˆØ¯Ø© ğŸ”™", callback_data="admin_back")]])
    )

async def admin_back_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„"""
    query = update.callback_query
    await query.answer()
    
    # Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
    if 'admin_action' in context.user_data:
        del context.user_data['admin_action']
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„
    keyboard = [
        [InlineKeyboardButton("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ğŸ‘¥", callback_data="admin_manage_admins")],
        [InlineKeyboardButton("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ğŸ‘¤", callback_data="admin_manage_users")],
        [InlineKeyboardButton("Ø¥Ø¯Ø§Ø±Ø© Ù…ÙØ§ØªÙŠØ­ API ğŸ”‘", callback_data="admin_manage_api_keys")],
        [InlineKeyboardButton("Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª ğŸ“Š", callback_data="admin_stats")],
        [InlineKeyboardButton("Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ ğŸ“£", callback_data="admin_broadcast")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡:",
        reply_markup=reply_markup
    )

# ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª
def register_admin_handlers(application):
    """ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„"""
    application.add_handler(CommandHandler("admin", admin_command))
    application.add_handler(CommandHandler("status", admin_stats_callback))
    application.add_handler(CommandHandler("podcast", admin_broadcast_callback))
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø±
    application.add_handler(CallbackQueryHandler(admin_manage_admins_callback, pattern="^admin_manage_admins$"))
    application.add_handler(CallbackQueryHandler(admin_add_admin_callback, pattern="^admin_add_admin$"))
    application.add_handler(CallbackQueryHandler(admin_remove_admin_callback, pattern="^admin_remove_admin$"))
    application.add_handler(CallbackQueryHandler(admin_process_remove_admin, pattern="^admin_remove_[0-9]+$"))
    application.add_handler(CallbackQueryHandler(admin_broadcast_callback, pattern="^admin_broadcast$"))
    application.add_handler(CallbackQueryHandler(admin_stats_callback, pattern="^admin_stats$"))
    application.add_handler(CallbackQueryHandler(admin_manage_users_callback, pattern="^admin_manage_users$"))
    application.add_handler(CallbackQueryHandler(admin_search_user_callback, pattern="^admin_search_user$"))
    application.add_handler(CallbackQueryHandler(admin_edit_wallet_callback, pattern="^admin_edit_wallet$"))
    application.add_handler(CallbackQueryHandler(admin_edit_subscription_callback, pattern="^admin_edit_subscription$"))
    application.add_handler(CallbackQueryHandler(admin_cancel_callback, pattern="^admin_cancel$"))
    application.add_handler(CallbackQueryHandler(admin_back_callback, pattern="^admin_back$"))
