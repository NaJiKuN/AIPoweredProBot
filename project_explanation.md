# شرح مشروع بوت تليجرام AIPoweredProBot

## 1. نظرة عامة على المشروع

يهدف هذا المشروع إلى إنشاء بوت تليجرام متقدم (`AIPoweredProBot`) يوفر للمستخدمين الوصول إلى مجموعة متنوعة من نماذج الذكاء الاصطناعي (AI) لإنشاء المحتوى (نصوص، صور، فيديوهات، موسيقى) عبر منصة واحدة. يعتمد البوت على نظام اشتراكات وحزم مدفوعة يتم شراؤها باستخدام رصيد محفظة داخلي، والذي يمكن شحنه عبر بوابة الدفع Plisio باستخدام نجوم تليجرام.

**الميزات الرئيسية (المنفذة جزئياً والمخطط لها):**

*   **تعدد نماذج AI:** دعم نماذج متعددة مثل GPT، Gemini، Claude، Midjourney، Flux، Suno وغيرها.
*   **نظام المحفظة:** لكل مستخدم محفظة برصيد من العملات (⭐) يمكن شحنها.
*   **الاشتراكات والحزم:** تقديم خطط اشتراك (مجانية، مميزة) وحزم طلبات محددة يمكن شراؤها من رصيد المحفظة.
*   **إدارة المستخدمين:** تسجيل المستخدمين تلقائياً وتمييز المسؤولين.
*   **إدارة المسؤولين:** لوحة تحكم للمسؤولين لإدارة مفاتيح API، المستخدمين، وإرسال رسائل جماعية.
*   **إدارة مفاتيح API:** إضافة وتعديل وحذف وتفعيل/إلغاء تفعيل مفاتيح API للنماذج المختلفة.
*   **تكامل بوابة الدفع:** ربط مع Plisio لشحن رصيد المحفظة (قيد التطوير).
*   **تعدد اللغات:** دعم واجهة المستخدم بلغات متعددة (قيد التطوير).
*   **إدارة السياق:** حفظ سياق المحادثة مع نماذج AI (قيد التطوير).
*   **واجهة تفاعلية:** استخدام الأزرار المضمنة (Inline Keyboards) لتسهيل التنقل والتفاعل.

## 2. هيكلية المشروع

تم تنظيم المشروع في ملفات ومجلدات لتسهيل الصيانة والتطوير:

*   **`bot.py`:** الملف الرئيسي للبوت. يحتوي على:
    *   إعدادات تسجيل الدخول (Logging).
    *   تعريف حالات المحادثات (ConversationHandler states).
    *   تعريف الأسعار (PRICES).
    *   المعالج الرئيسي لردود الأزرار (`button_callback_handler`).
    *   المعالج الرئيسي للرسائل النصية للتفاعل مع AI (`text_message_handler`).
    *   الدالة الرئيسية `main()` التي تقوم بتهيئة البوت، تحميل المعالجات، وتشغيل البوت.
*   **`config.py`:** يحتوي على إعدادات التكوين الأساسية:
    *   `TOKEN`: توكن البوت.
    *   `ADMIN_IDS`: قائمة بمعرفات المستخدمين المسؤولين الأوليين.
    *   `DATABASE_NAME`: اسم ملف قاعدة البيانات.
    *   `DEFAULT_MODEL`: النموذج الافتراضي للمستخدمين الجدد.
    *   `PLISIO_SECRET_KEY`: المفتاح السري لبوابة الدفع Plisio.
*   **`database.py`:** مسؤول عن جميع عمليات قاعدة البيانات (SQLite):
    *   `init_db()`: لإنشاء الجداول عند بدء التشغيل.
    *   `_execute_query()`: دالة مساعدة لتنفيذ استعلامات SQL.
    *   دوال لإدارة المستخدمين (`add_or_update_user`, `get_user`, `is_user_admin`, ...).
    *   دوال لإدارة المسؤولين (`add_admin`, `remove_admin`, `get_admin_ids`).
    *   دوال لإدارة مفاتيح API (`add_api_key`, `get_api_key`, `update_api_key`, ...).
    *   دوال لإدارة الاشتراكات والحزم (`grant_free_trial`, `grant_premium`, `add_package`, `get_user_subscription_status`, `consume_request`).
    *   دوال لإدارة المحفظة (`get_wallet_balance`, `add_wallet_balance`, `deduct_wallet_balance`).
    *   دوال لإدارة السياق (`update_user_context`, `get_user_context`).
    *   دالة لتسجيل الاستخدام (`log_usage`).
*   **`utils.py`:** يحتوي على دوال مساعدة وأدوات متنوعة:
    *   Decorators للتحقق من صلاحيات المستخدم (`admin_required`, `user_registered`).
    *   `check_and_consume_request()`: للتحقق من رصيد المستخدم واستهلاك الطلب قبل التفاعل مع AI.
    *   `format_account_status()`: لتنسيق وعرض حالة حساب المستخدم (الاشتراكات، الحزم، الرصيد).
    *   `format_api_key_list()`: لتنسيق قائمة مفاتيح API للمسؤول.
    *   `parse_callback_data()`: لتحليل بيانات الأزرار المضمنة.
*   **`keyboards.py`:** مسؤول عن إنشاء لوحات المفاتيح المضمنة (Inline Keyboards) المستخدمة في البوت:
    *   تعريف البادئات (Prefixes) لتمييز أنواع بيانات الأزرار (`CB_PREFIX_ACTION`, `CB_PREFIX_MODEL`, ...).
    *   دوال لإنشاء لوحات المفاتيح المختلفة (القائمة الرئيسية، قائمة المسؤول، قائمة الاشتراكات، قائمة الحزم، قائمة اختيار النماذج، إلخ).
*   **`requirements.txt`:** يسرد المكتبات اللازمة لتشغيل البوت.
*   **`handlers/` (مجلد):** يحتوي على ملفات المعالجات المنفصلة:
    *   **`__init__.py`:** ملف فارغ لتعريف المجلد كـ Python package.
    *   **`general_handlers.py`:** معالجات الأوامر العامة مثل `/start`, `/help`, `/privacy`.
    *   **`user_handlers.py`:** معالجات الأوامر الخاصة بالمستخدم مثل `/account`, `/premium`, `/settings`, `/model`, `/deletecontext`.
    *   **`admin_handlers.py`:** معالجات الأوامر الخاصة بالمسؤولين (`/admin`) والمحادثات المتعلقة بإدارة المفاتيح والمسؤولين والبث.
    *   **`ai_handlers.py`:** (تم إنشاؤه) مسؤول عن التفاعل الفعلي مع واجهات برمجة تطبيقات نماذج الذكاء الاصطناعي المختلفة. يحتوي حالياً على مثال لتكوين Gemini ودوال وهمية للنماذج الأخرى.
*   **`todo.md`:** قائمة المهام التفصيلية لتتبع التقدم في تطوير الميزات المتبقية.

## 3. الوظائف الأساسية

*   **التسجيل والتحقق:** يتم تسجيل المستخدم تلقائياً عند أول تفاعل (`user_registered` decorator). يتم التحقق من صلاحيات المسؤول (`admin_required` decorator).
*   **إدارة المحفظة:** تم إضافة حقل `wallet_balance` في قاعدة البيانات ودوال لإدارته (`get`, `add`, `deduct`).
*   **منطق الشراء:** تم ربط أزرار شراء الاشتراكات والحزم في `bot.py` للتحقق من رصيد المحفظة (`get_wallet_balance`) وخصمه (`deduct_wallet_balance`) قبل منح الاشتراك (`grant_premium`) أو إضافة الحزمة (`add_package`).
*   **إدارة API Keys:** يمكن للمسؤولين إضافة وتعديل وحذف وتفعيل/إلغاء تفعيل مفاتيح API عبر لوحة التحكم.
*   **اختيار النموذج:** يمكن للمستخدم اختيار النموذج المفضل عبر `/settings` أو `/model`، ويتم حفظه في قاعدة البيانات.
*   **التفاعل الأساسي مع AI:** المعالج `text_message_handler` في `bot.py` يستقبل الرسائل النصية، يتحقق من النموذج المفضل والمفتاح النشط، يتحقق من رصيد الطلبات ويستهلكه (`check_and_consume_request`)، ثم يوجه الطلب إلى `ai_handlers.get_ai_response` (حالياً يرد برسالة تجريبية أو يتصل بـ Gemini إذا تم تكوينه).

## 4. كيفية تشغيل البوت

1.  **تثبيت المتطلبات:**
    ```bash
    pip install -r requirements.txt
    ```
2.  **إعداد التكوين:** تأكد من صحة `TOKEN` و `ADMIN_IDS` في ملف `config.py`.
3.  **تشغيل البوت:**
    ```bash
    python bot.py
    ```
    سيقوم البوت بإنشاء قاعدة البيانات (`AIPoweredProBot.db`) إذا لم تكن موجودة والبدء في استقبال الرسائل.

## 5. التطوير المستقبلي والتوسعة

الكود الحالي يوفر بنية أساسية قوية، ولكن العديد من الميزات المتقدمة تتطلب تطويرًا إضافيًا كما هو موضح في `todo.md`، وأهمها:

*   **تكامل Plisio:**
    *   تثبيت مكتبة Plisio (إذا كانت متوفرة) أو استخدام `requests` للتفاعل مع API الخاص بهم.
    *   إنشاء وظائف لإنشاء فواتير الدفع بنجوم تليجرام.
    *   إعداد webhook أو آلية للتحقق من حالة الدفع وتحديث رصيد المحفظة (`add_wallet_balance`).
    *   إضافة أزرار شراء الرصيد في `/account` لتبدأ عملية الدفع.
*   **تكامل كامل لنماذج AI:**
    *   تثبيت المكتبات اللازمة لكل نموذج (openai, anthropic, etc.).
    *   استكمال الدوال في `ai_handlers.py` للتفاعل الفعلي مع كل API باستخدام المفاتيح من قاعدة البيانات.
    *   التعامل مع أنواع مختلفة من المخرجات (نصوص، روابط صور، ملفات فيديو/صوت).
    *   تطبيق نظام تكلفة مختلف لكل نموذج/نوع طلب وتحديث `consume_request`.
*   **تعدد اللغات (i18n):**
    *   استخدام مكتبة مثل `python-i18n`.
    *   نقل النصوص الثابتة إلى ملفات JSON (مثل `locales/ar.json`, `locales/en.json`).
    *   تعديل الكود لاستخدام دوال الترجمة بناءً على لغة المستخدم.
*   **إدارة السياق:**
    *   تحديد استراتيجية حفظ السياق (في `user_data` المؤقت أو `database`).
    *   تعديل `ai_handlers.py` لتمرير السياق إلى نماذج AI التي تدعمه.
    *   تطبيق حدود لحجم السياق.
*   **استكمال منطق الأوامر:**
    *   تنفيذ الواجهات والمنطق التفصيلي لأوامر مثل `/midjourney`, `/video`, `/photo`, `/suno`, `/s` كما هو مطلوب.
    *   استكمال قائمة `/settings` بإضافة خيارات التعليمات المخصصة، الردود الصوتية، إلخ.
*   **تحسينات إضافية:**
    *   إضافة زر الاشتراك المجاني الأسبوعي.
    *   منع شراء الحزم المتكررة شهرياً (إذا لزم الأمر).
    *   تحسين عرض الإحصائيات للمسؤول.
    *   إضافة معالجة للأخطاء بشكل أفضل.

## 6. ملاحظات هامة

*   **الأمان:** تأكد من حماية توكن البوت ومفاتيح API والمفتاح السري لـ Plisio.
*   **إدارة الأخطاء:** الكود الحالي يحتوي على معالجة أساسية للأخطاء، ولكن يجب تحسينها لتوفير تجربة أفضل للمستخدم والمسؤول.
*   **الاختبار:** يجب إجراء اختبار شامل لجميع الميزات بعد استكمال التطوير، خاصة عمليات الدفع والتفاعل مع نماذج AI المختلفة.

نأمل أن يكون هذا الشرح مفيداً ويوفر أساساً جيداً لاستكمال تطوير البوت.
